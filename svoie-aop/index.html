<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="verify-admitad" content="b4f109c5f4" />

    <title>Свое АОP в JDK</title>
    <meta name="description" content="Автоматизация рутины приоритетнее давления массой">
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta property="og:site_name" content="Заметки Автоматизатора">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Свое АОP в JDK">
    <meta property="og:image" content="http://automation-remarks.com/images/blog-logo.png"/>

        	<meta property="og:description" content="Заметка о том, как можно реализовать AOP без Spring и AspectJ."/>
	
	<link rel="stylesheet" href="../css/blueimp-gallery.min.css">	
    <link rel="stylesheet" type="text/css" href="../css/dependencies.min.css"/>
    <link rel="stylesheet" href="../css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/style.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/blog.css" />

    <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

       ga('create', 'UA-57010828-1', 'auto');
       ga('send', 'pageview');

    </script>
</head>

<body>
    <section id="wrapper">
        <div id="ajax-container">
	<script>var disqus="httpspirogovgithubio";</script>

<nav id="nav" class="nav">
        <div class="nav-panel">
          <a class="main_link" href="/">
            <span class="name">Главная</span>
          </a>
          <a class="video_link" href="/podcast" style="
              width: 5em;
          ">
                      <span class="name">Подкаст</span>
                    </a>
          <a class="author_link" href="/archive.html" style="
              width: 5em;
          ">
                      <span class="name">Архив</span>
                    </a>
          <a class="author_link" href="/author/">
            <span class="name">Об Авторе</span>
          </a>
          <a class="course_link" href="https://spirogov.github.io" style="
              width: 7em;
          ">
                      <span class="name">Обучение</span>
          </a>
        </div>

        <div class="nav-menu">
          <a class="rss" href="https://www.facebook.com/automationremarks"><i class="fa fa-facebook"></i></a>
          <a class="rss" href="https://vk.com/qaremarks"><i class="fa fa-vk"></i></a>
          <a class="rss" href="https://twitter.com/s_pirogov"><i class="fa fa-twitter"></i></a>
          <a class="rss" href="https://qaguild-slack.herokuapp.com/"><i class="fa fa-slack"></i></a>
        </div>
</nav>
	
	<main class="content" role="main">
		<article class="post">
			<div class="inner inner-post">
				<div id="push">
                    <header class="post-header">
                        <span class="post-meta">
                            <span class="post-author">
                                <a href="/author/index.html">Сергей Пирогов</a>
                            </span> |
                            <span class="post-date">
                                29/03/2015
                            </span>
                        </span>
                        <div class="clear"></div>
                        <h1 class="post-title">Свое АОP в JDK</h1>
                    </header>

                    <section class="post-content">
                        <div class="paragraph">
<p>Заметка о том, как можно реализовать <strong>AOP</strong> без <strong>Spring</strong> и <strong>AspectJ</strong>. Для тех, кто не особо в курсе, что такое AOP смотреть суда. Итак, приступим. Создадим нашу мини программу:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface Calculator {
    public int calculate( int a , int b);
}

public class CalculatorImpl implements Calculator {
    @Override
    public int calculate(int a, int b) {
        System.out.println("**********Actual Method Execution**********");
        return a/b;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Класс <strong>Calculator</strong> будет имеенно тем классом, который мы будем проксировать. В java есть такой интересный интерфейс <strong>InvocationHandler</strong>, его мы и будем использовать для нашей реализации <strong>AOP</strong>. Создадим абстрактный <strong>Handler</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public abstract class AbstractHandler implements InvocationHandler {

    private Object targetObject;

    public void setTargetObject(Object targetObject) {
        this.targetObject = targetObject;
    }

    public Object getTargetObject() {
        return targetObject;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>ProxyFactory</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class ProxyFactory {

public static Object getProxy(Object targetObject,
        List&lt;AbstractHandler&gt; handlers) {
    Object proxyObject = null;
    if (handlers.size() &gt; 0) {
        proxyObject = targetObject;
        for (int i = 0; i &lt; handlers.size(); i++) {
            handlers.get(i).setTargetObject(proxyObject);
            proxyObject = Proxy.newProxyInstance(targetObject.getClass()
                    .getClassLoader(), targetObject.getClass()
                    .getInterfaces(), handlers.get(i));
        }
        return proxyObject;
    } else {
        return targetObject;
    }
}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>В AOP существует несколько срезов: <strong>Before</strong>, <strong>After</strong>, <strong>AfterThrowing</strong>, <strong>AfterReturning</strong> и <strong>Around</strong>.</p>
</div>
<div class="paragraph">
<p>Так как реализации каждого среза могут быть разными, для разных случаев, создадим для них абстрактные классы:</p>
</div>
<div class="paragraph">
<p>Пример для <strong>AfterHandler</strong> и <strong>BeforeHandler</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public abstract class AfterHandler extends AbstractHandler {

    /**
     * Handles after the execution of method.
     *
     * @param proxy the proxy
     * @param method the method
     * @param args the args
     */
    public abstract void handleAfter(Object proxy, Method method, Object[] args);

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {

        Object result = method.invoke(getTargetObject(), args);
        handleAfter(proxy, method, args);
        return result;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>AbstractBeforeHandler:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public abstract class BeforeHandler extends AbstractHandler {

    /**
     * Handles before execution of actual method.
     *
     * @param proxy the proxy
     * @param method the method
     * @param args the args
     */
    public abstract void handleBefore(Object proxy, Method method, Object[] args);

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        handleBefore(proxy, method, args);
        return method.invoke(getTargetObject(), args);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь нам нужно сделать конкретные реализации для каждого из срезов:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class AfterHandlerImpl extends AfterHandler {

    @Override
    public void handleAfter(Object proxy, Method method, Object[] args) {
        //Provide your own cross cutting concern
        System.out.println(method.getName() + Arrays.toString(args));
        System.out.println("Handling after actual method execution ........");
    }
}

public class BeforeHandlerImpl extends BeforeHandler {

    @Override
    public void handleBefore(Object proxy, Method method, Object[] args) {
        //Provide your own cross cutting concern
        System.out.println("Handling before actual method execution ........");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь мы можем легко проксировать наш <strong>Calculator</strong> класс:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class TestAopInJDK {

    public static void main(String[] args) {
        CalculatorImpl calcImpl = new CalculatorImpl();
        BeforeHandler before = new BeforeHandlerImpl();
        AfterHandler after = new AfterHandlerImpl();
        List&lt;AbstractHandler&gt; handlers = new ArrayList&lt;AbstractHandler&gt;();
        handlers.add(before);
        handlers.add(after);
        Calculator proxy = (Calculator) ProxyFactory.getProxy(calcImpl,
                handlers);
        int result = proxy.calculate(20, 10);
        System.out.println("FInal Result :::" + result);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>После запуска вывод в консоль оказывается таким:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">Handling before actual method execution ........
**********Actual Method Execution**********
calculate[20, 10]
Handling after actual method execution ........
Final Result :::2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как вы можете заметить срабатывает Before, затем идет работа метода и затем срабатывает After.
<strong>P.S.</strong>
Многие кто не сильно в теме могут сказать, что такое же можно было реализовать просто написав перед вызовом и после вызова sysout. Да, можно было, но AOP предназначено немного для других целей.Я уже описывал то как мы используем логер для действий вебдрайвера здесь. В своих фреймворках, я дополнительно логирую имена методов и параметры которые он принимают используя AOP. Это позволяет хранить весь код логирования в одном месте,а не розмазывать его по всем классам.</p>
</div>
                    </section>

                    <footer class="post-footer">
                            <div class="post-tags">
                                    <a style="background: cornflowerblue;"
                                       href="/tags/Тест-фреймворк.html">Тест фреймворк</a>
                                    <a style="background: cornflowerblue;"
                                       href="/tags/Java.html">Java</a>
                            </div>
                    </footer>

                    <div class="row">
                        <h2 style="margin-top: 20px;">Слушайте QAGuild подкаст</h2>
                        <iframe width="100%" height="450" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/422684588&color=%238c8c64&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true" style="margin-bottom: unset;"></iframe>
                    </div>

                    <div class="row">
                          <div class="col-md-6">
                                <div class='related-posts-holder'>
                                     <h2>Похожие заметки:</h2>
                                     <ul class="related-posts">
                                                <li><a class='js-ajax-link' href="/2018/qa-guild-ep21/index.html">Эпизод-21: Дно автоматизации и cypress.io</a></li>
                                                <li><a class='js-ajax-link' href="/2018/qa-guild-19/index.html">Эпизод-19: Новости, беседы, внезапный гость</a></li>
                                                <li><a class='js-ajax-link' href="/2018/rest-assured/index.html">Почему Rest Assured не так уж и хорош</a></li>
                                                <li><a class='js-ajax-link' href="/2018/qa-guild-18/index.html">Эпизод-18: Размышления на тему роста и развития QA специалистов</a></li>
                                                <li><a class='js-ajax-link' href="/2018/java-training/index.html">Тренинг Automation in Action Java</a></li>
                                                <li><a class='js-ajax-link' href="/2018/telegram/index.html">Telegram канал - automation-remarks.com</a></li>
                                                <li><a class='js-ajax-link' href="/2018/qa-guild-ep17/index.html">Эпизод-17: Александр Венгер о том, как стать самым крутым и другие инсайды с тестатонов</a></li>
                                     </ul>
                                 </div>
                          </div>
                          <div class="col-md-6">

                          </div>
                    </div>
				</div>

				 <!-- Begin MailChimp Signup Form -->
                                   <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
                                   <style type="text/css">
                                   	#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
                                   	/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                                   	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
                                   </style>
                                   <div id="mc_embed_signup">
                                   <form action="//automation-remarks.us10.list-manage.com/subscribe/post?u=d24f95005c1b66c13389aceb9&amp;id=ce47ec0c3f" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                                       <div id="mc_embed_signup_scroll">
                                   	<label for="mce-EMAIL">Подписывайтесь на email рассылку</label>
                                   	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
                                       <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                                       <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_d24f95005c1b66c13389aceb9_ce47ec0c3f" tabindex="-1" value=""></div>
                                       <div class="clear"><input type="submit" value="Подписаться" name="subscribe" id="mc-embedded-subscribe" class="button" style="background: black;"></div>
                                       </div>
                                   </form>
                                   </div>

                                   <!--End mc_embed_signup-->

				<aside class="post-comments">
                    <div id="disqus_thread">
                        <script async="async">(function(d, s, id) {
                                  var js, fjs = d.getElementsByTagName(s)[0];
                                  if (d.getElementById(id)) return;
                                  js = d.createElement(s); js.id = id;
                                  js.src = "//connect.facebook.net/ru_RU/sdk.js#xfbml=1&version=v2.5&appId=344312565764603";
                                  fjs.parentNode.insertBefore(js, fjs);
                                }(document, 'script', 'facebook-jssdk'));
                        </script>
                    </div>
                </aside>
			</div>
		</article>
	</main>

            <footer id="footer">
              <section class="credits">
                <span class="credits-software">Published with <a href="http://jbake.org/">JBake</a></span>
              </section>
            </footer>
         </div>
    </section>

    <script type="text/javascript" src="../js/dependencies.min.js"></script>
    <script type="text/javascript" src="../js/script.js" async="async"></script>
    <script src="//my.hellobar.com/b89babe68c85bfcf7416926983e86b31a9467186.js" type="text/javascript" charset="utf-8" async="async"></script>
</body>
</html>